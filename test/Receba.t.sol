// SPDX-License-Identifier: AGPL-3.0
pragma solidity ^0.8.21;

import { PoseidonT2 } from "poseidon-solidity/PoseidonT2.sol";
import { PoseidonT3 } from "poseidon-solidity/PoseidonT3.sol";
import { Test, stdJson } from "forge-std/Test.sol";
import { ERC721Holder } from "@openzeppelin/contracts/token/ERC721/utils/ERC721Holder.sol";
import { Deliverable } from "../contracts/Deliverable.sol";
import { Receba, UltraVerifier } from "../contracts/Receba.sol";

contract RecebaTest is Test, ERC721Holder {
  using stdJson for string;

  uint256 internal constant BOB_KEY = 0xb0b;
  address internal immutable BOB = vm.addr(BOB_KEY);

  Deliverable public deliverable;
  Receba public receba;

  function setUp() external {
    deliverable = new Deliverable();
    receba = new Receba(deliverable, 1 ether, new UltraVerifier());
    vm.label(BOB, "bob");
  }

  function test() external {
    uint256 secret = 420;
    uint256 nullifier = 69;
    bytes32 commitment = bytes32(PoseidonT3.hash([nullifier, secret]));
    bytes32 nullifierHash = bytes32(PoseidonT2.hash([nullifier]));
    receba.deposit{ value: 1 ether }(commitment);
    receba.withdraw(
      payable(address(0x11)),
      payable(address(0x22)),
      33,
      0x2432ed3bfbc63acf84c018272f20505534230dbac3746bf9fbd7d95ddfc80f45,
      nullifierHash,
      hex"0972875d385e251d6ad07b464efb4f8e2193dd0f174c11ca2d68b8730d4c2d6e2b955a6eeeaafbc30f9d85e4687c06204c0b80f62cfb875b6c9b12ddadffeda813dc70509d289317d7bee48d3309688ccfc8355b1f5b23023e51b1933efc1d381e9ac57f31f7dd9cfe364cd0b20adeaa6af7e0e2083618e99961372bfe59f18a0eb97f014ca7aeaebc97f5d21f8e45a6eefca374f809c363c07bb938cd503ca7026b65d3c2a2c64b2171963dab2d28ed4791f4f5e5c3aee03abb0c7c45126fc41291a5f131a8bd6c2f9149f318b819b57b3385d286804848237c979fb9a306f2205d110019cba636e566f7b1249a5ec57f658fbf5846f28d85e7e4d62f16a1421eba775dbd40ed2622348270146f0e7382b98396978e39d8edbddec482f79a8f21c7bf48a12ae196702152594a2aa8dfd7203034a087f8ac405663dd3a8d932c07ba9c848746c83fc6d206605cdd04064737a13b682fa84cb458b241262c08662ce168a945fd35c02a91555699cc521e46ccceb3be916f4f0c5157e2fc3e99400a3b41101c8e3784176a562cfc53d2b6ce4d52faf5ac06ad89197b03f05c5668108d3c90fa78ef8d2ab958feb121b01240731d72736b1c0bec62ce91b9a6cdea196bc30e2d1cc0bb3d5bb848a91136471b718d16c80e292c24936061e145501a2ff1aee3f15368f411584fe1dec048c14fd7ece386cc5997d61d0ef31facef622904a99112ee4d653f5394c003074f769f65eee23e8a5ef075de93e4dd5374012086e880aa43ae1c094b1970f4633f6b935e398327949ebd3d8bbaaf41d2db9f185d59300a80111fe77b1e211f5898eb9236b5fd901275e34f31dc3d006514b4294cd9f079ea9bf2707d2b2aa1c898fd885fd17c31e9214878e0c2fb550b707105cb573a66b3ff667866974a8d6bef5cd2a7863993a2833de81ac42869b64fa1274f2058011857f50a2f5ae26568410037e377f107ff3b6a623713cfa1e1b0e120b9dec7f8116ebffab5a0c376b2f8ff6998d157a4db47958f51ef54015a516c21c6665f338ba1e9d1d786060b91937fc41c43dc244aed9258c92ca8912f80bb056397efae8c29a568f5a3d31ab56460d5393e2e1f2c042364e0674933a4429315c1af975f66cf9975b3bcd749fd4ef805c2fdd98b319d2d72265c2142bf070917fe7b66a32e673e5be9e7d691d0af76ed12505772e6573c5f725cab5432a36d0132156015d939d33b556bde6899981d5226547d594f64fd596bfd60024f3b1b0febe06bd5635605e6669a30667c140696857503c55b95aaca815747ba492bca1347f13c92cfec5ba7c28639fa9a5d840fa13216cae9c8de32675ede58f8db1504c60ab77a2ac995adafd387edd8c953e02500e804e31619926d9475d7b537ac23ab55fe4976dc9221e4dc83081531355d5171768bac5a214cf6381749cd319523fdf3d8852bfaa636a0c83be178746a4f5c97be7274d93cf38b61bd4d0b068f0637e98a0456a91bb979d2fcc398cb27ddb0bfe473e7f16499c769729efc04cf18f030c5fd0cfe72bec133cae1c34bf19bdd61c2276657fc05184f685fc4657c1b0f93cc15eaca2253c268091fb07f2c656886f4fa18b0cb0ad193b06a4f570b19255b35575aba90ad1f28a07a772614a6987230b8cde7d12a5a9f6137d385740de068f2f2621eae193f93f8019b697ea79e1470adc7cd7d721e2f8540c485b40f6b1f46d46d05a4ff9bf9be3aacae1af3216c0b6bc18efd2976df779d4c22c80405a62167d36eaf84fedb006e8b39fded6eb6990bd5cbc6d49bcfa5a9882e591aa86bcd94d40c0e9e0eea202d0174006f802708655bc5103a74ee72b145db990808e65a8ffa9fb56ed33085b90b7ba45bed68a5c89ff68a2b6cd4ed44f8054e265738e9b178c3427d336abed1eb50a0039903848df867ffb9d0fc33b948a8a112808bee9882d392cc54c54aaccf37538a281b40e7b511fc98283f5c565b5cf0140b42427a8dba89b2b12b10e5e07befd5ab72dba5aed37c4f80ef4eb2e2fa041595f8965c98a180990d90d71ef1c08c212eca7663a894fc06d99f410f6a97181720aeea3ea388777f69f69d580305286cb2221121a2567bbe324f336bf2342c10f5d59ab677ec9be5f85f8473bdf2b73ea4c3a629bb507ce0cf8f69f9d3bfdc1f9bbe62e79b6f2681da9cef3a75c41c8ade812816e5793854281aadb5bc6fdd2635e9799ea548f99c4d9c4d1873fb86a6dc42acc06bd934c74d44558140e2160c4ff067842b8f1195c835d6f1804faa9667ac55884efb62bab0b357da3eb51710987d0ca7464a661307d7f60d0269a4fb384768d587f3098a8bbedbc7995763117fd7322a05c3222e07e314b3e59862c3ec310bd423b3db1e0202b133fe31fa07c895fe2371bea94f1d52bdf5c53d5270980045443bcaf790db213831cb7ef428d3a84d1a85d6cb1663a52300664abfc5a9acd178c7cc3e4714a8aa51a0b9f02ed61020204c4dc40ec6f23edfa40f1e7ff2602adc6d5933d93959897e24db9b01da242b2e1336a33cfd4dce9fcfaa25932b3b172c24ccab9a93be7eb10feea70bc836199b44f6c181eac5a7b9943cf2f994a9a8dcfa0da11758a915fb4d81891d2634712cc4f9532ad0a837c260cbeee39aa685c763371c0870d06988b41d6420416fa9e1d422ce2b999d8feb93985fc4b634900ba090f8992b6e0dbc00ed790ec7c2f2d6d122f8a26fa2fa893f5596445a6d7dd9e0ae261efb90e6925656982db264aeacffc34cd195ee1ba86c6b29ec328eb421da3be4e8ada95358abbfb81c38b7f7a1fcc377486bf386461828606bd6c7a1f01a59126e7dcc2c2f0128d72a2024c927ecb2916baac3e6bfec1ad5b3751e1b5bcec16f482c68fb618c137b295e451a3efab01aa06a8db5f7aafd8bb0aea37a17b5e2982237589731169c7800d76912a9abe8fb87af06aa58c0c11fdca1dded7818f0f1ded299dd047f7cd4108a56a05bac21f4d9a82b8f4707ef3761825c2a63473c80003dd95e7715e014"
    );
  }

  receive() external payable { }
}
