// SPDX-License-Identifier: AGPL-3.0
pragma solidity ^0.8.21;

import { PoseidonT2 } from "poseidon-solidity/PoseidonT2.sol";
import { PoseidonT3 } from "poseidon-solidity/PoseidonT3.sol";
import { Test, stdJson } from "forge-std/Test.sol";
import { ERC721Holder } from "@openzeppelin/contracts/token/ERC721/utils/ERC721Holder.sol";
import { Deliverable } from "../contracts/Deliverable.sol";
import { Receba, UltraVerifier } from "../contracts/Receba.sol";

contract RecebaTest is Test, ERC721Holder {
  using stdJson for string;

  uint256 internal constant BOB_KEY = 0xb0b;
  address internal immutable BOB = vm.addr(BOB_KEY);

  Deliverable public deliverable;
  Receba public receba;

  function setUp() external {
    deliverable = new Deliverable();
    receba = new Receba(deliverable, 1 ether, new UltraVerifier());
    vm.label(BOB, "bob");
  }

  function test() external {
    uint256 secret = 420;
    uint256 nullifier = 69;
    bytes32 commitment = bytes32(PoseidonT3.hash([nullifier, secret]));
    bytes32 nullifierHash = bytes32(PoseidonT2.hash([nullifier]));
    receba.deposit{ value: 1 ether }(commitment);
    receba.withdraw(
      payable(address(0x11)),
      payable(address(0x22)),
      33,
      0x2432ed3bfbc63acf84c018272f20505534230dbac3746bf9fbd7d95ddfc80f45,
      nullifierHash,
      hex"2a8e542f72792d7afdcf2cf7381b4b4e3a44e1e92c01011f8e5b9d16b15c1ee12fca4f9d6c68b2de3b079ae6de26571fe5e247e85c3480c306e96cc2f90d89b5255923cdf5e07063fa89d97a637674b9de1b302b2fe7921dd02c2691360af1491bd4b4b11f4ca30dcc1b370fec359cf15600aa02e00f8af8105507d80c8b1fa518cc8cae1acc09a511b040968ba2478f6306611687b89fc737f6d664afbcaf3f0383702e796c974cb1080855c4b6fba63aa82c524879720296da4d56bdbe53311fbd62d7dd7c485d3f596bd46c38aa7e845b0ed1cb70f9a0c945d4cd0df341310df20bba2e88d589744e3a0555a6f9a5108864392ec9fc4ba23d952da6fed8692f86962463e1b062bd80dfa25c25c52bd12a71ff99e9f6237af6e9cc106f5c532328bdef91bfb5450bbe3773bcd84ba90c5b96c5cb21158df1889d3a53bc5f572085407450e6fa829add6cfb32b2cea65f2362354a69797ec93ccb5247c5e17d2ab966e599590bac3281e337ce4b9f50c2d1cbc671ea3985889e9932c8a1061426e3088692b73b9dd65b09468e1c276b4ba6ecd1503745664082f428a388134718691ed4902264a42f65ef6a800e780048774337ae6b403631d8225186e4251b096b8a7ddbfad7554307226a0bf2802c58c11262a87763b307daacae412be2ba28f5e3e191e8e8859f23be09af413286603652059c28097ca079be48442b6d9f239a7ae3511269227db316a84b7f245a18cd9e2c80d43bdb0dd1b04398855742006d4c2ec096b0454d4b30141283f4f42a7e39d9872a4250c19c765145088a151fb4310a748f43f8dab7612e84fa27e2b7b9db4e839021d70cdc4557ffb457a910d321bb9323bca2fc75b4717ae2a47be0af4e8bc2c6033009d1aa1cc240cd062a97b8d33868b36d844c455c13b7c3b69c329c8021aeabe43c7520edb3530b6a17d76d1ae4fb050e13d5ff5d5007c4731d83a099124f9cd13cc153b7f050f4a62c5935936321bfd83002445fd9483d92fe8a9fdb90d5c3bcdac4efb9cdb35ae4141b1fac072ba1d28e4638570117b49b15fb575623e60e937ef245107c51e57329aeae52af9d3792a3568585c18a01b47d378f92f5a946898064214621a3356e0980428680a7b90f829f0db6a0d65fe2046fada4b4fa151b455a5fe3f5f851082deaddb62d4589790cc08f407b99cab5ec049cafed54caaf0dd493c040a84e4d05dbd5b22ea7bdb3bf9585ea95c85bcc606ebfe1ab8a80a45f8f9d74870b3b0010b09e17b0725d95ea71dba75b4a3d8d6d64372d71c82c718f6ee30a74f4122a21d6a50af18d819909b8fe06ec4741a0dfd9bb798c36b87e4030d034e8b33352000f9de6fc9b5c2b6085b49496d6fd65f576ecf9c5a6199b91797f3447a6c60c292c3f1aad14dd44b901e8e0e68b52d4b906add0d0c6987f5bf97cc35205b318104a78bdf3b048e97692c9d6f796c66634692de69fe1c6c29983907afd53aa171dc158a46becaa95d908d9f5126c26443c13e015db774adc94b9fb6515e68472287aca52b4b30816d5b44fa55802d6fa9397a6a274872e83ee58722834ac929921d277ab053fb9f217b3ada7f6604910869c7199290ee2c51a75dfc0ee55b4212b3a460e6a51d01bfbd363f136184fa0c6cab80b8f90f66bf6dbcf289b16fb0f2811ed2fc9c7da7b5eda11d4df030bda5f080095091beba1d395f86d68ce9cb01ec79ff8210ebb3b7d86bd88ca600feedcb7b643399dd7b62b8bae33c8c72550274828e5f5ae9f0362a7c8f8dc610d4c5809c7d4293d3db70320b8edf0d696ca2f13b1726f672de7b0a9f5115223510c7373ad5e6b4fedbcb338f1df0f2da86108d682afb8902b99b4d09bdc292acd0464bb7cb231032b11904fd3e3408b22d02e43591fd033c823da102f1aa66f11c9c97e89bf455dff0a1943a8706877f542152a5d4876e9633358ed3ea228587f8fb93d65ebbafeef219786a7849668d0ea0edd2d50b09f3b70ac48f83beb74fb76d74f325df64a9af6d8d6e1e1a59c37a8088ffd58ea5513adffa4b1d5ae91775df560fed0319646cc1a271c3eb4cf9e660242cd61240aebeb53006b6f71adf3451372cb426ce1f2a15b77569bc40305241b778d403d338af605918508653c03a89b2b99797fb3434c56366d2787356a2c2ff60d50d6ffb1f9c1b56aa18741b34e353b5af7de95ce9f40aabf4d40cb71912bd93781c7809629bf45cf95a0cb38d8ccbcb70a745fc5ea79bef28673d7b2870c22fde3272c03edb0fd0ee1162fbc1c13abcfc9d1b1136060399fbb350f4743172b6d8751f7bb08d1ee5ac1696c483dd66e04a82f17cafe8a24237326eef3480ca667d8154047bef77a0766c75fb66b4a7fc16d7fe4cbc47f8cd0e376ed32f6130c0566efdbb9990bd5f953a2b1f2434abf8d18345d4c7c949755cbd9fd42e91f16eb1621d0116bda8b91ae036f7b24062afc243e106f62f67bcbed2ab581a02012cd30cacac41ac5be1c388ab0f57fa1582e75a422b5bf2db17cb042a27f42229df20eeaaf18c3f8befce72e01e9ff227d48aa7310c7f41726528516165f2311dfc85be7c867e552d599a3d2b69208c22061ceb9e673745d7e7a0d2bf63ca8186d59ecf5d727c26ef8910c762055709382221755cf1297ba812dd2fda066ae258a74e418f1379f4e0027ccbc3cd301898437ec1577d78c47d872950f9686e828ab53f71b0551973f2ad5c8769739ec54f9e73fc1ec7ed7f87fd176d0e312262bcc330a1d196b8f305583c430f1a0d7206f96936e612623a9273058922f9d642eed121d1f2d8587218031bfeb4c07c1ebe545e71ad5cd6f59ce8f3a537c28a22e7b80aea6d5c3bb98aeb6289fcb02c73c66e58dad1fee06df8d1419c1faef931a405b41623ab8ce7f985f6b75fdd074a970f450b027882a0394627cea9f82462d5e9d14897067f7e07ad091d0e685b2ac8982086a3a2d4bcd26c86a4389347021cf5d24d2b2387fd911f2d97417b488857bd03eb64b3b49f9af4738dea2f318"
    );
  }

  receive() external payable { }
}
